# ============================================================================
# POLITICALL - Docker Compose para Produção
# ============================================================================
# Desenvolvido por: David Flores Andrade
# Website: www.politicall.com.br
# ============================================================================
#
# Uso:
#   docker-compose up -d
#
# Para atualizar imagem:
#   docker-compose pull && docker-compose up -d
#
# Volume de Uploads:
#   Os arquivos de imagem (avatares e backgrounds) são armazenados em volume
#   persistente. São acessíveis publicamente pois são usados em páginas públicas
#   como /apoio/:slug e landing pages de pesquisa. A segurança é garantida por:
#   - Nomes de arquivo aleatórios de 32 caracteres hex (impossível adivinhar)
#   - express.static não permite listagem de diretórios
#   - Validação de MIME type impede execução de código malicioso
# ============================================================================

version: '3.8'

services:
  politicall:
    image: ghcr.io/davidfloresandrade/politicall:latest
    container_name: politicall-app
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - DATABASE_URL=postgresql://auth_bd:4uth@1307BD@172.17.0.1:5432/politicall
      - SESSION_SECRET=${SESSION_SECRET:-politicall-production-secret-2024}
    volumes:
      # Volume persistente para uploads de imagens
      - politicall_uploads:/app/uploads
    networks:
      - politicall-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

networks:
  politicall-network:
    driver: bridge

volumes:
  politicall_uploads:
    driver: local
